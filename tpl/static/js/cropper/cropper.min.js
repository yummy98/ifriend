var isIE=(document.all)?true:false;var isIE6=isIE&&([/MSIE (\d)\.0/i.exec(navigator.userAgent)][0][1]==6);var ica_fc=function(a){return"string"==typeof a?document.getElementById(a):a};var Class={create:function(){return function(){this.initialize.apply(this,arguments)}}};var Extend=function(a,c){for(var b in c){a[b]=c[b]}};var Bind=function(b,a){return function(){return a.apply(b,arguments)}};var BindAsEventListener=function(c,a){var b=Array.prototype.slice.call(arguments).slice(2);return function(d){return a.apply(c,[d||window.event].concat(b))}};var CurrentStyle=function(a){return a.currentStyle||document.defaultView.getComputedStyle(a,null)};function addEventHandler(b,c,a){if(b.addEventListener){b.addEventListener(c,a,false)}else{if(b.attachEvent){b.attachEvent("on"+c,a)}else{b["on"+c]=a}}}function removeEventHandler(b,c,a){if(b.removeEventListener){b.removeEventListener(c,a,false)}else{if(b.detachEvent){b.detachEvent("on"+c,a)}else{b["on"+c]=null}}}var ImgCropper=Class.create();ImgCropper.prototype={initialize:function(a,e,c,b){this._Container=ica_fc(a);this._layHandle=ica_fc(e);this.Url=c;this._layBase=this._Container.appendChild(document.createElement("img"));this._layCropper=this._Container.appendChild(document.createElement("img"));this._layCropper.onload=Bind(this,this.SetPos);this._tempImg=document.createElement("img");this._tempImg.onload=Bind(this,this.SetSize);this.SetOptions(b);this.Opacity=Math.round(this.options.Opacity);this.Color=this.options.Color;this.Scale=!!this.options.Scale;this.Ratio=Math.max(this.options.Ratio,0);this.Width=Math.round(this.options.Width);this.Height=Math.round(this.options.Height);var f=ica_fc(this.options.Preview);if(f){f.style.position="relative";f.style.overflow="hidden";this.viewWidth=Math.round(this.options.viewWidth);this.viewHeight=Math.round(this.options.viewHeight);this._view=f.appendChild(document.createElement("img"));this._view.style.position="absolute";this._view.onload=Bind(this,this.SetPreview)}this._drag=new Drag(this._layHandle,{Limit:true,onMove:Bind(this,this.SetPos),Transparent:true});this.Resize=!!this.options.Resize;if(this.Resize){var g=this.options,d=new Resize(this._layHandle,{Max:true,onResize:Bind(this,this.SetPos)});g.RightDown&&(d.Set(g.RightDown,"right-down"));g.LeftDown&&(d.Set(g.LeftDown,"left-down"));g.RightUp&&(d.Set(g.RightUp,"right-up"));g.LeftUp&&(d.Set(g.LeftUp,"left-up"));g.Right&&(d.Set(g.Right,"right"));g.Left&&(d.Set(g.Left,"left"));g.Down&&(d.Set(g.Down,"down"));g.Up&&(d.Set(g.Up,"up"));this.Min=!!this.options.Min;this.minWidth=Math.round(this.options.minWidth);this.minHeight=Math.round(this.options.minHeight);this._resize=d}this._Container.style.position="relative";this._Container.style.overflow="hidden";this._layHandle.style.zIndex=200;this._layCropper.style.zIndex=100;this._layBase.style.position=this._layCropper.style.position="absolute";this._layBase.style.top=this._layBase.style.left=this._layCropper.style.top=this._layCropper.style.left=0;this.Init()},SetOptions:function(a){this.options={Opacity:50,Color:"",Width:0,Height:0,Resize:false,Right:"",Left:"",Up:"",Down:"",RightDown:"",LeftDown:"",RightUp:"",LeftUp:"",Min:false,minWidth:50,minHeight:50,Scale:false,Ratio:0,Preview:"",viewWidth:0,viewHeight:0};Extend(this.options,a||{})},Init:function(){this.Color&&(this._Container.style.backgroundColor=this.Color);this._tempImg.src=this._layBase.src=this._layCropper.src=this.Url;if(isIE){this._layBase.style.filter="alpha(opacity:"+this.Opacity+")"}else{this._layBase.style.opacity=this.Opacity/100}this._view&&(this._view.src=this.Url);if(this.Resize){with(this._resize){Scale=this.Scale;Ratio=this.Ratio;Min=this.Min;minWidth=this.minWidth;minHeight=this.minHeight}}},SetPos:function(){if(isIE6){with(this._layHandle.style){zoom=0.9;zoom=1}}var p=this.GetPos();this._layCropper.style.clip="rect("+p.Top+"px "+(p.Left+p.Width)+"px "+(p.Top+p.Height)+"px "+p.Left+"px)";this.SetPreview()},SetPreview:function(){if(this._view){var p=this.GetPos(),s=this.GetSize(p.Width,p.Height,this.viewWidth,this.viewHeight),scale=s.Height/p.Height;var pHeight=this._layBase.height*scale,pWidth=this._layBase.width*scale,pTop=p.Top*scale,pLeft=p.Left*scale;with(this._view.style){width=pWidth+"px";height=pHeight+"px";top=-pTop+"px ";left=-pLeft+"px";clip="rect("+pTop+"px "+(pLeft+s.Width)+"px "+(pTop+s.Height)+"px "+pLeft+"px)"}}},SetSize:function(){var a=this.GetSize(this._tempImg.width,this._tempImg.height,this.Width,this.Height);this._layBase.style.width=this._layCropper.style.width=a.Width+"px";this._layBase.style.height=this._layCropper.style.height=a.Height+"px";this._drag.mxRight=a.Width;this._drag.mxBottom=a.Height;if(this.Resize){this._resize.mxRight=a.Width;this._resize.mxBottom=a.Height}},GetPos:function(){with(this._layHandle){return{Top:offsetTop,Left:offsetLeft,Width:offsetWidth,Height:offsetHeight}}},GetSize:function(a,e,d,c){var b=a,g=e,f=b/g;if(c){b=(g=c)*f}if(d&&(!c||b>d)){g=(b=d)/f}return{Width:b,Height:g}}};